
---

## **STEPS TO CREATE THE HIPERLIFE DOCKER IMAGE**

---

**1. Make sure you have:**

In your folder ( tools/docker/):

```
├── Dockerfile-app          # Custom Dockerfile
├── docker-compose.yaml     # Defines the container service
├── initHL.sh               # Initialization and build script
├── .env                    # Customizable environment variables
├── detect-compiler.sh      # Automatically detects architecture and sets compilers

```
----------

**2. Build the image**

From the folder where Dockerfile-app is located, run:
```
docker build -t darecfm/hiperlife-app:latest -f Dockerfile-app .
```

•  darecfm/hiperlife-app: name of your custom image, you can use any name you like. But if you change it, remember to update the image name in the docker-compose.yaml file.

•  Dockerfile-app: your Dockerfile.

----------

**3. Start the container**

  • Default initialization (uses "hl-base-project" as the project name):
```
docker compose up 
```

  • Custom initialization (the user defines the project name):

```
PROJECT_NAME=Project-Name docker compose up
```

  • You can also customize the number of Threads to use:
```
PROJECT_NAME=Project-Name NUM_THREADS=5 DEBUG_MODE=1 docker-compose up
```

 • If you have previously built this image, you can omit `--build`. However, including it will force the Docker image to rebuild, which is useful if you’ve made changes to the `Dockerfile` or other files:
```
PROJECT_NAME=project-name docker compose up --build
```


This:

•  Starts the hiperlife-container

•  Automatically runs initHL.sh inside the container

•  Copies and compiles the hl-base-project

•  Leaves an active terminal ready for work

----------

**4. Stop Docker**

```
docker compose down                         # To stop and remove the container
docker rmi darecfm/hiperlife-app:latest     # To remove the image if desired
```

---
--------------
---
---

---
---
## **STEPS TO TEST YOUR APP WITH DOCKER + HIPERLIFE + VS CODE**
---

Below is a technical description of the complete flow for preparing, configuring, and running a Hiperlife-based application inside a Docker container using Visual Studio Code and Dev Containers.

## 1. Prerequisites

#### 1. Docker

- You must have **Docker Engine** (version **20.x or higher**) and **Docker Desktop** (version **4.x or higher**) installed and running on your operating system (Linux or macOS).
- Check that it’s working with the following commands:

  ```bash
  docker version
  docker info
  ```
  
#### 2. Visual Studio Code (VS Code)

- **Recommended version:** ≥ 1.100 (or the latest LTS version).
- It must be **installed locally** and up to date.



#### 3. hiperlife Repository

- Sample source code (e.g.: `hl-base-project`) or your own project based on the Hiperlife framework.

- **Expected structure (inside External/):**

      ```
      External/                            
      ├── hl-bin/                            
      │   └── hlproject-name                    # Compiled and installed binary (by CMake + make install)
      └── project-name/                        # Main project   
          ├── userConfig.cmake                 # Defines PROJECT_NAME and list of applications
          ├── README.md                        # Technical documentation of the project
          ├── CMakeLists.txt                   # Root CMake that includes subproject project-name/
          ├── .gitignore     
          └── .vscode/                         # VS Code configuration (build, debug, IntelliSense)
          │    ├── launch.json                 # Configures execution and debugging of hlPrueba70
          │    ├── tasks.json                  # Custom build task with MPI + hiperlife   
          │    ├── c_cpp_properties.json       # Include paths, toolchain, and IntelliSense
          │    └── settings.json               # Configuration args for CMake (HL_BASE_PATH, etc.)
          └──build/                            # Build artifacts generated by CMake
          │    ├── CMakeFiles/                 # Internal CMake files 
          │    ├── project-name/               # Folder containing the compiled binary            
          │    ├── cmake_install.cmake         # Generated install script
          │    ├── cmake.log                   # Log generated by `cmake .. > cmake.log`
          │    ├── CMakeCache.txt              # CMake options cache
          │    │── compile_commands.json       # Index generated automatically by CMake
          │    ├── install_manifest.txt        # Installed files log
          │    └── Makefile                    # Generated Makefile for compilation
          └── project-name/                    # Subdirectory with the main application
              ├── project-name.cpp             # Main source file of the app
              ├── AuxEmptyApp.cpp              # Auxiliary file (e.g., for separate functions)
              ├── AuxEmptyApp.h                # Auxiliary header
              └── CMakeLists.txt               # CMake for the hlPrueba70 executable
      ```
    > **Note:**  You can replace all instances of project-name if you generate another project (PRueba80, SimXYZ, etc.) automatically from your initHL.sh script.       


## 2. Required Extensions in Visual Studio Code

To work properly with the dockerized hiperlife environment, make sure you have the following VS Code extensions installed:

#### • Dev Containers

- **ID:** `ms-vscode-remote.remote-containers`  
- **Functionality:** Allows you to open project folders and development environments directly inside Docker containers from VS Code. This extension is essential to enable the full Dev Containers experience.

#### • C/C++

- **ID:** `ms-vscode.cpptools`  
- **Functionality:** Enables IntelliSense, definition navigation, build and debugging (GDB/LLDB) for C/C++ projects.

### • CMake

- **ID:** `twxs.cmake`  
- **Functionality:** Provides basic support for syntax and highlighting in `CMakeLists.txt` files and scripts.

### • CMake Tools

- **ID:** `ms-vscode.cmake-tools`  
- **Functionality:** Adds advanced CMake integration in VS Code:  
  manages configuration, generation, and build of CMake projects from the GUI, with quick commands, target lists, automated tasks, and support for `compile_commands.json`.

> **Note:** After installing these extensions, restart Visual Studio Code to ensure they load correctly in the container.


## 3. VS Code Configuration for Dev Containers

#### 1. Open VS Code

- Open Visual Studio Code normally (not in a container yet).

#### 2. Check Extensions

- In the left sidebar, click the **Extensions** icon (or press `Ctrl+Shift+X`).
- Confirm that **Dev Containers**, **C/C++**, **CMake**, **CMake Tools**, **Dev Containers**, **Docker**, and **Docker Explorer** are installed and enabled.

#### 3. Open Remote Explorer

- Press `Ctrl+Shift+E` (or click the “Explorer” icon).
- From the sidebar, select the **Remote Explorer** icon (monitor with an arrow).
- In the **Dev Containers** section, you’ll see the built/prepared Docker containers (e.g., `docker-hiperlife-container-1` if it exists or your own `hiperlife-dev:latest` tag).

#### 4. Start and Attach to a Container

- If you already have a running container (e.g., `docker-hiperlife-container-1`), it will appear in the list.
- Otherwise, VS Code will detect the `.devcontainer` folder (if it exists) or suggest you create it.

**To attach:**
- `Attach in Current Window` (Arrow ↪): opens the container in the **same VS Code window**.
- `Attach in New Window` (Window icon): opens a **new VS Code instance** connected to the container.

-  Select your preferred option. VS Code will automatically:

    1. Connect to Docker.

    2. Start the container (if it’s not running).

    3. Mount your project folder inside the container.
    4. Set up development paths (IntelliSense, terminal, etc.).

>  **Note:**  
> If you’ve never created a `devcontainer` for your project, VS Code will guide you to generate a `.devcontainer/devcontainer.json` file where you can specify the image (`hiperlife-dev:latest`) and the configuration for your environment.


## 4. Navigate to the Application Directory Inside the Container

#### 1. Open the Integrated Terminal
- Inside VS Code (already connected to the container), go to the top menu: Terminal > New terminal
- Make sure you are inside the container by checking the system prompt, which should look like: `(hl-user@container-id) /home/hl-user/External/project-name`

#### 2. Change to Your Application Directory "Open Workspace"
- Before building or debugging, it’s essential that VS Code is pointing directly to your application directory (and not the generic External folder). To do this:
    - In the top bar of VS Code, go to File > Open Folder.
    - Navigate to /External/project-name and open it.
    - Check that the File Explorer (left sidebar) shows only your application’s content (.cpp files, CMakeLists.txt, etc.).

#### 3. Select the settings in the top search bar
- First select [Scan For Kits]
- Then select the GCC 11.4.0 aarch64-linux -gnu compiler


>  **Note:** Important: If you open only the External folder, build and debug tasks will not find the executable or the correct configuration and will fail.


## 5. Execution and Debugging from VS Code

1. **“Run” Button in the lower status bar**

   - With the correct folder selected, click the ▶ (“Run”) icon at the bottom of the status bar.
   - This will execute the default configuration for your project (e.g., “Run hl”) as defined in `launch.json`.

2. **Run with F5 or the Debugging icon**

   - Alternatively, press **F5** or use the **Start Debugging** icon, making sure to set a breakpoint before starting the debugger.
   - VS Code will launch the debugger as specified in `launch.json`:
     - It will build automatically (preLaunchTask = “CMake Build”).
     - It will start GDB and stop at the first breakpoint (if you’ve set one).

4. **Manual execution in terminal**
   - If you prefer not to use the integrated debugger, you can keep working in the integrated terminal (press <kbd>Ctrl</kbd>+<kbd>`</kbd>).
   - From `/External/project-name/`, run:
     ```bash
     mpirun -np 4 /home/hl-user/External/hl-bin/hl<project-name>
     ```
   - Adjust `-np 4` to the number of MPI processes you need.



## 6. Stop or Restart the Container

  1. Open **Remote Explorer** in the sidebar (monitor with arrow icon).

2. In the **Dev Containers** section, find your container (e.g., `docker-hiperlife-container-1`).

3. Click the X icon (“Remove Container”) next to its name:
   - This will stop the container and remove it from the list.
   - If you want to develop again, select your Docker image (e.g., `hiperlife-dev:latest`) 

  > **Note:** Stopping the container does not remove the image, so your changes in `/External/project-name` will persist as long as you don’t manually delete the folder or the Docker image.
